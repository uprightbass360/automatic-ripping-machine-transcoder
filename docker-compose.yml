services:
  # Webhook receiver and transcode orchestrator
  arm-transcoder:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arm-transcoder
    restart: unless-stopped
    ports:
      - "${WEBHOOK_PORT:-5000}:5000"
    environment:
      - TZ=${TZ:-America/New_York}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Paths inside container
      - RAW_PATH=/data/raw
      - COMPLETED_PATH=/data/completed
      - WORK_PATH=/data/work
      - DB_PATH=/data/db/transcoder.db
      # Authentication
      - REQUIRE_API_AUTH=${REQUIRE_API_AUTH:-false}
      - API_KEYS=${API_KEYS:-}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
      # Transcoding
      - VIDEO_ENCODER=${VIDEO_ENCODER:-nvenc_h265}
      - VIDEO_QUALITY=${VIDEO_QUALITY:-22}
      - AUDIO_ENCODER=${AUDIO_ENCODER:-copy}
      - SUBTITLE_MODE=${SUBTITLE_MODE:-all}
      - HANDBRAKE_PRESET=${HANDBRAKE_PRESET:-H.265 NVENC 1080p}
      - HANDBRAKE_PRESET_4K=${HANDBRAKE_PRESET_4K:-H.265 NVENC 2160p 4K}
      - HANDBRAKE_PRESET_FILE=${HANDBRAKE_PRESET_FILE:-}
      # File handling
      - DELETE_SOURCE=${DELETE_SOURCE:-true}
      - OUTPUT_EXTENSION=${OUTPUT_EXTENSION:-mkv}
      # Organization
      - MOVIES_SUBDIR=${MOVIES_SUBDIR:-movies}
      - TV_SUBDIR=${TV_SUBDIR:-tv}
      - AUDIO_SUBDIR=${AUDIO_SUBDIR:-audio}
      # Performance
      - MAX_CONCURRENT=${MAX_CONCURRENT:-1}
      - STABILIZE_SECONDS=${STABILIZE_SECONDS:-60}
      - MINIMUM_FREE_SPACE_GB=${MINIMUM_FREE_SPACE_GB:-10}
      - MAX_RETRY_COUNT=${MAX_RETRY_COUNT:-3}
      - LOG_PATH=/data/logs
    volumes:
      - ${HOST_RAW_PATH}:/data/raw:ro
      - ${HOST_COMPLETED_PATH}:/data/completed:rw
      - ${WORK_PATH:-./work}:/data/work:rw
      - ${DB_PATH:-./data}:/data/db:rw
      - ${PRESET_PATH:-./presets}:/config/presets:ro
      - ${LOG_PATH:-./logs}:/data/logs:rw
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, video, compute]
    runtime: nvidia
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Run ARM ripper alongside (uncomment if desired)
  # arm-rippers:
  #   image: automaticrippingmachine/automatic-ripping-machine:latest
  #   container_name: arm-rippers
  #   restart: always
  #   privileged: true
  #   ports:
  #     - "${ARM_PORT:-8080}:8080"
  #   environment:
  #     - ARM_UID=${ARM_UID}
  #     - ARM_GID=${ARM_GID}
  #     - TZ=${TZ}
  #   volumes:
  #     - ${HOST_RAW_PATH}:/home/arm/media/raw
  #     - ${HOST_COMPLETED_PATH}:/home/arm/media/completed
  #     - ${ARM_LOGS_PATH}:/home/arm/logs
  #     - ./config/arm:/etc/arm/config
  #   cpuset: ${ARM_CPUSET:-2,3,4,5,6,7}
