# ARM Transcoder - Security-Hardened Deployment
# This compose file adds security layers without modifying application code

services:
  # Security proxy - handles auth, rate limiting, input validation
  security-proxy:
    image: traefik:v2.11
    container_name: arm-transcoder-proxy
    restart: unless-stopped
    ports:
      - "${WEBHOOK_PORT:-5000}:80"
      - "${ADMIN_PORT:-8080}:8080"  # Traefik dashboard
    command:
      # Enable dashboard
      - "--api.dashboard=true"
      - "--api.insecure=true"

      # Entrypoints
      - "--entrypoints.web.address=:80"

      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.filename=/config/dynamic.yml"
      - "--providers.file.watch=true"

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"

      # Rate limiting (global)
      - "--entrypoints.web.http.middlewares=rate-limit@file"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./security/traefik:/config:ro
    networks:
      - arm-network
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Main application (behind proxy)
  arm-transcoder:
    build:
      context: .
      dockerfile: Dockerfile.secure
    container_name: arm-transcoder-app
    restart: unless-stopped
    expose:
      - "5000"  # Not published directly - only via proxy
    environment:
      - TZ=${TZ:-America/New_York}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RAW_PATH=/data/raw
      - COMPLETED_PATH=/data/completed
      - WORK_PATH=/data/work
      - DB_PATH=/data/db/transcoder.db
      # Security: API keys handled by proxy, not exposed to app
    volumes:
      - ${NFS_RAW_PATH}:/data/raw:ro,nosuid,nodev
      - ${NFS_COMPLETED_PATH}:/data/completed:rw,nosuid,nodev
      - ${WORK_PATH:-./work}:/data/work:rw,nosuid,nodev
      - ${DB_PATH:-./data}:/data/db:rw,nosuid,nodev
      - ${PRESET_PATH:-./presets}:/config/presets:ro
    networks:
      - arm-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 2G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, video, compute]
    runtime: nvidia
    # Security: run as non-root
    user: "1000:1000"
    # Security: read-only root filesystem
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100M
    # Security: capabilities
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined  # Required for GPU access
    labels:
      # Traefik configuration
      - "traefik.enable=true"

      # Webhook endpoint
      - "traefik.http.routers.webhook.rule=PathPrefix(`/webhook`)"
      - "traefik.http.routers.webhook.entrypoints=web"
      - "traefik.http.routers.webhook.middlewares=webhook-auth,webhook-ratelimit,webhook-validation"

      # API endpoints
      - "traefik.http.routers.api.rule=PathPrefix(`/jobs`) || PathPrefix(`/health`) || PathPrefix(`/stats`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.middlewares=api-auth,api-ratelimit"

      # Service
      - "traefik.http.services.arm-transcoder.loadbalancer.server.port=5000"

      # Health check
      - "traefik.http.services.arm-transcoder.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.arm-transcoder.loadbalancer.healthcheck.interval=10s"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  arm-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
